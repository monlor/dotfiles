#!/bin/bash

# é¢œè‰²è¾“å‡º
GREEN="\033[1;32m"
RED="\033[1;31m"
RESET="\033[0m"

# ç¡®ä¿ age å’Œ age-keygen å·²å®‰è£…
if ! command -v age &>/dev/null; then
    echo -e "${RED}âŒ é”™è¯¯: age æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… ageã€‚${RESET}"
    exit 1
fi

if ! command -v age-keygen &>/dev/null; then
    echo -e "${RED}âŒ é”™è¯¯: age-keygen æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… age-keygenã€‚${RESET}"
    exit 1
fi

# ç”Ÿæˆ Age å¯†é’¥ï¼Œå¹¶å­˜å…¥çŽ¯å¢ƒå˜é‡
init_age_key() {
    echo -e "${GREEN}ðŸ”‘ ç”Ÿæˆ Age å¯†é’¥...${RESET}"
    key=$(age-keygen)
    export AGE_PRIVATE_KEY="$(echo "$key" | tail -n 1)"
    export AGE_PUBLIC_KEY="$(echo "$key" | grep -o 'age1[^\"]*')"

    echo -e "${GREEN}âœ… Age å¯†é’¥å·²ç”Ÿæˆ.${RESET}"
    echo -e "ðŸ”’ ä½ å¯ä»¥å°†ä»¥ä¸‹å‘½ä»¤æ·»åŠ åˆ° GitHub Secrets æˆ– .bashrc ä»¥ä¾¿ä½¿ç”¨:"
    echo -e "${GREEN}export AGE_PRIVATE_KEY=\"$AGE_PRIVATE_KEY\"${RESET}"
    echo -e "${GREEN}export AGE_PUBLIC_KEY=\"$AGE_PUBLIC_KEY\"${RESET}"
}

# ç»Ÿä¸€åŠ å¯†æ–‡ä»¶/ç›®å½•
encrypt() {
    if [ -z "$AGE_PUBLIC_KEY" ]; then
        echo -e "${RED}âŒ æœªæ£€æµ‹åˆ° AGE_PUBLIC_KEYï¼Œè¯·å…ˆè¿è¡Œ: $0 init${RESET}"
        exit 1
    fi

    if [ "$#" -eq 0 ]; then
        echo -e "${RED}âŒ è¯·è¾“å…¥è¦åŠ å¯†çš„æ–‡ä»¶æˆ–ç›®å½•${RESET}"
        exit 1
    fi

    for TARGET in "$@"; do
        if [ -f "$TARGET" ]; then
            echo -e "ðŸ” åŠ å¯†å•ä¸ªæ–‡ä»¶: $TARGET -> $TARGET.age"
            age -r "$AGE_PUBLIC_KEY" -o "$TARGET.age" "$TARGET"
            rm -f "$TARGET"  # åˆ é™¤åŽŸå§‹æ–‡ä»¶
        elif [ -d "$TARGET" ]; then
            echo -e "${GREEN}ðŸ”’ å¼€å§‹åŠ å¯†ç›®å½•: $TARGET${RESET}"
            find "$TARGET" -type f ! -name ".*" ! -name "*.age" | while read -r file; do
                echo -e "ðŸ” åŠ å¯†: $file -> $file.age"
                age -r "$AGE_PUBLIC_KEY" -o "$file.age" "$file"
                rm -f "$file"  # åˆ é™¤åŽŸå§‹æ–‡ä»¶
            done
        else
            echo -e "${RED}âŒ ç›®æ ‡ä¸å­˜åœ¨: $TARGET${RESET}"
        fi
    done
}

# ç»Ÿä¸€è§£å¯†æ–‡ä»¶/ç›®å½•
decrypt() {
    if [ -z "$AGE_PRIVATE_KEY" ]; then
        echo -e "${RED}âŒ æœªæ£€æµ‹åˆ° AGE_PRIVATE_KEYï¼Œè¯·å…ˆè¿è¡Œ: $0 init${RESET}"
        exit 1
    fi

    if [ "$#" -eq 0 ]; then
        echo -e "${RED}âŒ è¯·è¾“å…¥è¦è§£å¯†çš„æ–‡ä»¶æˆ–ç›®å½•${RESET}"
        exit 1
    fi

    for TARGET in "$@"; do
        if [ -f "$TARGET" ] && [[ "$TARGET" == *.age ]]; then
            original_file="${TARGET%.age}"
            echo -e "ðŸ”“ è§£å¯†å•ä¸ªæ–‡ä»¶: $TARGET -> $original_file"
            age -d -i <(echo "$AGE_PRIVATE_KEY") -o "$original_file" "$TARGET"
            rm -f "$TARGET"  # åˆ é™¤åŠ å¯†æ–‡ä»¶
        elif [ -d "$TARGET" ]; then
            echo -e "${GREEN}ðŸ”“ å¼€å§‹è§£å¯†ç›®å½•: $TARGET${RESET}"
            find "$TARGET" -type f -name "*.age" | while read -r file; do
                original_file="${file%.age}"
                echo -e "ðŸ”“ è§£å¯†: $file -> $original_file"
                age -d -i <(echo "$AGE_PRIVATE_KEY") -o "$original_file" "$file"
                rm -f "$file"  # åˆ é™¤åŠ å¯†æ–‡ä»¶
            done
        else
            echo -e "${RED}âŒ ç›®æ ‡ä¸å­˜åœ¨æˆ–ä¸æ˜¯ .age æ–‡ä»¶: $TARGET${RESET}"
        fi
    done
}

# æ˜¾ç¤ºå¸®åŠ©
usage() {
    echo "ç”¨æ³•: $0 [init|encrypt|decrypt] [æ–‡ä»¶/ç›®å½•...]"
    echo "  init      - ç”Ÿæˆ Age å¯†é’¥ï¼Œå¹¶å­˜å…¥çŽ¯å¢ƒå˜é‡"
    echo "  encrypt   - åŠ å¯†æ–‡ä»¶æˆ–ç›®å½•ï¼ˆæ”¯æŒå¤šä¸ªï¼‰"
    echo "  decrypt   - è§£å¯†æ–‡ä»¶æˆ–ç›®å½•ï¼ˆæ”¯æŒå¤šä¸ªï¼‰"
    exit 1
}

# è§£æžå‚æ•°
case "$1" in
    init)
        init_age_key
        ;;
    encrypt)
        shift
        encrypt "$@"
        ;;
    decrypt)
        shift
        decrypt "$@"
        ;;
    *)
        usage
        ;;
esac


